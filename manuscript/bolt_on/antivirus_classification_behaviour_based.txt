# Behaviour based classification {#chapter-antivirus-behaviour-based-classification}

Classification is the process that gets you from "I have a file and do not know what this is" to "this file is malware".

Bonus points for the type of malware (trojans, infectors, ...) or the exact family name.

Even more bonus points for a detailed behaviour analysis.

There are many ways to classify files. And one of them is behaviour based. This is: observing the behaviour of the file and judging based on that.

**Advantages**

* Current Malware is server side generated. The files are very different - but the behaviour stays the same
    * Behaviour signatures work for months - hashes for minutes
* Behaviour on the system is quite simple to judge

**Disadvantages**

* Malware that only does malicious things on Mondays, or on Italian windows 7 will be hard to classify
* Malware *could* escape the analysis sandbox (bad configuration, unpatched vulnerabilities)
* Malware *could* detect it is running in a virtual machine and stop doing malicious things
* Especially Trojans could do the things advertised for minutes - and after that do malicious stuff
* It is slow. Even when running 30 VMs in parallel on a dedicated machine for 3 minutes each it will lack a good throughput
    * please do the maths for your malware situation
    * having worked for an AV vendor: We got 4 unique and new samples per second

In the Open Source world [Cuckoo Sandbox](https://cuckoosandbox.org/) became the standard tool for this kind of analysis. But development staled and the project was continued as [CAPEv2](https://github.com/kevoreilly/CAPEv2).

## Container, Virtual Machines or Bare Metal

Behaviour analysis of malware can either happen on virtual machines or Bare Metal. Both systems must be reset after each malware run. A virtual
 machine is much faster.

Container technology is cool for deployment but it is **not** a security feature and does **not** properly isolate the guest from the host.
Also: You can not simulate a totally different system in the container than on the host.

It is either a Virtual Machine or a (slow) Bare Metal system with hardware support for the reset.

If you use virtual machines: Run them on a dedicated analysis server and not on office environment.

## Networking

Malware is trying to connect to the C&C server. It needs either a real connection to the internet or a simulated server landscape.

You want to separate the analysis machine from the company network. First to avoid the malware to escape into the office net. Second to avoid your IP to be block listed by ISPs as malware source.

The analysis sandbox should be able to monitor network connections - you do not have to do that centrally at a firewall. If your sandbox does not offer sufficient network monitoring you can log the connections at a firewall.

But be aware that many connections will be hidden (tunneled through a non-suspicious protocol like DNS) or encrypted.

## Pafish

Virtual machines have a big disadvantage: They can be detected. Several characteristics are so typical for Virtual Machines that malware can detect them and just play nice.

There is a tool named [pafish](https://github.com/a0rtega/pafish) that detects sandboxes the way malware does.

Detection is based on:

* Number of CPU cores
* Hard disk names
* Installed guest tools
* Registry keys
* Default settings for virtual machines

Remove all those traces and you should be able to run malware without it detecting the machine.

Also: Never ever depend on one single way to classify ! Always use additional classifiers in parallel.

%% TODO: Add Anti-Sandbox tricks statistics https://www.ptsecurity.com/ww-en/analytics/antisandbox-techniques/

## Al-Khaser

[Al-Khaser](https://github.com/LordNoteworthy/al-khaser) extends the scope of Pafish to also include anti-debugging, anti-dumping and anti-disassembly.

## VMCloak

[VMCloak](http://vmcloak.org/) is a tool similar to
[Vagrant](https://www.vagrantup.com) - it creates virtual machines. But the main goal is to hide them from malware detection.

Use VMCloak to create a virtual machine and test if Pafish can identify it as VM.

CAPEv2 controls those VMs to do the analysis.

%% TODO: https://www.cyberbit.com/blog/endpoint-security/anti-vm-and-anti-sandbox-explained/

%% https://github.com/d4rksystem/VMwareCloak

## CAPEv2 Sandbox

CAPEv2 is an analysis environment. After setup you push files in and get behaviour reports, dropped files and verdicts out.

As you will want to set it up on a special machine and getting your own configuration will take hours or days it deserves an own chapter.

## Small print

I contributed to Pafish, VMCloak and Cuckoo Sandbox - I am biased. But as far as 
I know here are either no real alternatives or people keep telling me those tools are good.

Cuckoo Sandbox became CAPEv2.

## Something different: Inserting virtual machine traces into the system

A fun project that inserts typical VM traces into a system to sabotage malware that does use Anti-VM techniques is [malwarescarecrow](https://github.com/kaganisildak/malwarescarecrow).

This adds VM markers into a system and hopes malware will stop and hide.

This concept is the exact opposite of Pafish and VMCloak. It's no silver bullet but worth to try it in a master thesis if you want to write one.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% TODO Further reading

%% TODO: Uroboros single process monitoring for Linux: https://github.com/evilsocket/uroboros

%% # Cuckoo Sandbox

%% TODO: Sort out with "antivirus-detection-behaviour-based"

%% https://github.com/cert-ee/cuckoo3/

%% Hypervisor scanning: https://github.com/CERT-Polska/drakvuf-sandbox

%% ## Basics

%% ## Setup

%% TODO: https://hatching.io/blog/cuckoo-sandbox-setup

%% ## Writing detection rules

%% ## Weaknesses

%% TODO https://github.com/David-Reguera-Garcia-Dreg/anticuckoo

%% TODO: Pafish

%% TODO: https://0x00sec.org/t/defeating-userland-hooks-ft-bitdefender/12496

%% TODO: More evasions: https://evasions.checkpoint.com/


%% ## Ideas

%% TODO: Simulate network using honeypots (printer, desktops, server)

%% TODO: Polyswarm to get malware for detection improvements

%% Or use MSDN

%% TODO: NTP sandbox detection  https://isc.sans.edu/diary/rss/26534


%% ## Anti VM, Anti hooking

%% TODO: https://winternl.com/memfuck/
%% TODO: https://github.com/rwfpl/rewolf-wow64ext
%% TODO: https://rp.os3.nl/2020-2021/p68/report.pdf

%% ## Scan from hypervisor

%% TODO: Volatility

%% TODO: https://github.com/tklengyel/drakvuf

%% TODO VMI (Virtual Machine Introspection)

%% ## Further reading


%% TODO Suricata IDS plus Cuckoo: https://suricata.readthedocs.io/en/suricata-5.0.0/what-is-suricata.html

%% TODO https://capesandbox.com/analysis/10149/

%% TODO: Zeek.org rules for behaviour
%% TODO: https://medium.com/@abhijithraom1990/bro-zeek-the-modern-watchtower-9ef61b09f255